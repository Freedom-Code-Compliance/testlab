name: Pre-Merge Checks

on:
  pull_request:
    branches:
      - dev
      - main
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches:
      - dev
      - main

jobs:
  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run TypeScript type check
        run: npm run typecheck
        env:
          CI: true
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || 'placeholder-key' }}

  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build client
        run: npm run build:client
        env:
          CI: true
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || 'placeholder-key' }}

      - name: Verify build outputs
        run: |
          if [ ! -d "dist" ]; then
            echo "❌ Client build output missing"
            exit 1
          fi
          echo "✅ Build outputs verified"

  format-check:
    name: Code Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Check code formatting
        run: |
          if npm run format.check 2>/dev/null; then
            echo "✅ Format check passed"
          else
            echo "⚠️ Warning: format.check script not configured. Skipping format check."
            echo "Consider adding prettier and format.check script to package.json"
          fi
        continue-on-error: true

  lint-check:
    name: Lint Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Check for common issues
        run: |
          echo "Checking for console.log statements..."
          if grep -r "console\.log" src/ --include="*.ts" --include="*.tsx" | grep -v "console.error\|console.warn" | head -5; then
            echo "⚠️ Warning: Found console.log statements (excluding console.error/console.warn)"
            echo "Consider removing debug console.log statements before merging"
          fi

          echo "Checking for TODO/FIXME comments..."
          if grep -r "TODO\|FIXME\|HACK\|XXX" src/ --include="*.ts" --include="*.tsx" | head -5; then
            echo "⚠️ Warning: Found TODO/FIXME comments"
          fi
        continue-on-error: true

  all-checks:
    name: All Checks Summary
    runs-on: ubuntu-latest
    needs:
      [typecheck, build-check, format-check, lint-check]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          FAILED_JOBS=""

          if [ "${{ needs.typecheck.result }}" != "success" ]; then
            FAILED_JOBS="${FAILED_JOBS} typecheck"
          fi

          if [ "${{ needs.build-check.result }}" != "success" ]; then
            FAILED_JOBS="${FAILED_JOBS} build-check"
          fi

          # format-check is allowed to fail (warnings only, non-blocking if not configured)
          if [ "${{ needs.format-check.result }}" != "success" ]; then
            echo "⚠️ Format check failed or not configured (non-blocking)"
          fi

          if [ -n "$FAILED_JOBS" ]; then
            echo "❌ The following required checks failed:$FAILED_JOBS"
            echo "Please fix these issues before merging."
            exit 1
          fi

          echo "✅ All required checks passed"
          if [ "${{ needs.format-check.result }}" != "success" ]; then
            echo "⚠️ Note: Format check has warnings or is not configured (non-blocking)"
          fi

